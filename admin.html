<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .login-form {
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 100px auto;
            border: 1px solid #333;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
        }
        
        input[type="password"], input[type="text"], input[type="datetime-local"], input[type="number"] {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #444;
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
        }
        
        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px 0;
        }
        
        button:hover {
            background: #444;
            border-color: #fff;
        }
        
        .btn-primary {
            background: #4CAF50;
            border-color: #4CAF50;
            width: 100%;
        }
        
        .btn-danger {
            background: #f44336;
            border-color: #f44336;
        }
        
        .admin-panel {
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 10px;
            transition: all 0.3s;
            margin-bottom: 5px;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .tab-content {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        
        th {
            background: rgba(0, 0, 0, 0.5);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .card-form, .user-actions {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-row input {
            flex: 1;
            min-width: 150px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .error-message {
            color: #ff6b6b;
            margin-top: 10px;
            text-align: center;
        }
        
        .success-message {
            color: #4CAF50;
            margin-top: 10px;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            min-height: 150px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录页面 -->
        <div id="login-page">
            <div class="login-form">
                <h2>管理员登录</h2>
                <div class="input-group">
                    <label for="admin-password">密码</label>
                    <input type="password" id="admin-password" placeholder="请输入管理员密码">
                </div>
                <button class="btn-primary" id="login-btn">登录</button>
                <div class="error-message" id="login-error"></div>
            </div>
        </div>
        
        <!-- 管理员面板 -->
        <div id="admin-panel" class="admin-panel">
            <div class="header">
                <h1>系统管理后台</h1>
                <p>欢迎回来，管理员</p>
                <button id="logout-btn" style="width: auto; margin-top: 10px;">退出登录</button>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div>总用户数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-cards">0</div>
                    <div>有效卡密</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-merit">0</div>
                    <div>总功德值</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="online-users">0</div>
                    <div>今日登录</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="users-tab">用户管理</div>
                <div class="tab" data-tab="cards-tab">卡密管理</div>
                <div class="tab" data-tab="create-tab">生成卡密</div>
            </div>
            
            <!-- 用户管理 -->
            <div id="users-tab" class="tab-content active">
                <h3>用户列表</h3>
                <div class="user-actions">
                    <button id="refresh-users">刷新列表</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>昵称</th>
                                <th>设备ID</th>
                                <th>功德值</th>
                                <th>IP地址</th>
                                <th>最后登录</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <!-- 用户数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 卡密管理 -->
            <div id="cards-tab" class="tab-content">
                <h3>卡密列表</h3>
                <div class="user-actions">
                    <button id="refresh-cards">刷新列表</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="cards-table">
                        <thead>
                            <tr>
                                <th>卡密</th>
                                <th>状态</th>
                                <th>过期时间</th>
                                <th>绑定用户</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="cards-tbody">
                            <!-- 卡密数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 生成卡密 -->
            <div id="create-tab" class="tab-content">
                <h3>生成新卡密</h3>
                <div class="card-form">
                    <div class="form-row">
                        <input type="number" id="card-count" placeholder="生成数量" value="1" min="1" max="100">
                        <input type="number" id="card-days" placeholder="有效天数" value="30" min="1">
                    </div>
                    <button class="btn-primary" id="generate-cards">生成卡密</button>
                    <div class="success-message" id="generate-success"></div>
                </div>
                
                <h4>生成的卡密</h4>
                <textarea id="generated-cards" rows="10" readonly></textarea>
                <button id="copy-cards">复制卡密</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase配置 - 使用service role key以获得完整权限
        const supabaseUrl = 'https://cdwkrgnocltdekoyueuc.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkd2tyZ25vY2x0ZGVrb3l1ZXVjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODAxNTkxNCwiZXhwIjoyMDczNTkxOTE0fQ.hfAK5_9D9khVfEO5gvXmE8X-Uj9XNSL-ogRkt8t0cLw';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        const ADMIN_PASSWORD = '5418854188';
        
        // 登录功能
        document.getElementById('login-btn').addEventListener('click', function() {
            const password = document.getElementById('admin-password').value;
            const errorElement = document.getElementById('login-error');
            
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadDashboard();
                errorElement.textContent = '';
            } else {
                errorElement.textContent = '密码错误！';
            }
        });
        
        // 退出登录
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        });
        
        // 标签页切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // 加载仪表板数据
        async function loadDashboard() {
            await loadStats();
            await loadUsers();
            await loadCards();
        }
        
        // 加载统计信息
        async function loadStats() {
            try {
                // 总用户数
                const { count: userCount, error: userError } = await supabase
                    .from('merit')
                    .select('*', { count: 'exact', head: true });
                
                if (userError) throw userError;
                
                // 有效卡密数
                const { count: activeCardCount, error: cardError } = await supabase
                    .from('cards')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'active')
                    .gt('expiry_time', new Date().toISOString());
                
                if (cardError) throw cardError;
                
                // 总功德值
                const { data: meritData, error: meritError } = await supabase
                    .from('merit')
                    .select('count');
                
                if (meritError) throw meritError;
                
                const totalMerit = meritData ? meritData.reduce((sum, user) => sum + (user.count || 0), 0) : 0;
                
                // 今日登录用户数
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const { count: todayUsers, error: todayError } = await supabase
                    .from('merit')
                    .select('*', { count: 'exact', head: true })
                    .gte('last_login', today.toISOString());
                
                if (todayError) throw todayError;
                
                document.getElementById('total-users').textContent = userCount || 0;
                document.getElementById('active-cards').textContent = activeCardCount || 0;
                document.getElementById('total-merit').textContent = totalMerit;
                document.getElementById('online-users').textContent = todayUsers || 0;
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }
        
        // 加载用户列表
        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('merit')
                    .select('*')
                    .order('last_login', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = '';
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无用户数据</td></tr>';
                    return;
                }
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.nickname || '未知'}</td>
                        <td title="${user.device_id}">${user.device_id ? (user.device_id.length > 15 ? user.device_id.substring(0, 15) + '...' : user.device_id) : '未知'}</td>
                        <td>${user.count || 0}</td>
                        <td>${user.ip_address || '未知'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString() : '从未登录'}</td>
                        <td>
                            <button onclick="resetMerit('${user.user_id}')">重置功德</button>
                            <button class="btn-danger" onclick="deleteUser('${user.user_id}')">删除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('加载用户失败:', error);
                document.getElementById('users-tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ff6b6b;">加载失败</td></tr>';
            }
        }
        
        // 加载卡密列表
        async function loadCards() {
            try {
                const { data: cards, error } = await supabase
                    .from('cards')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const tbody = document.getElementById('cards-tbody');
                tbody.innerHTML = '';
                
                if (!cards || cards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无卡密数据</td></tr>';
                    return;
                }
                
                cards.forEach(card => {
                    const isExpired = new Date(card.expiry_time) < new Date();
                    const status = card.status === 'active' && !isExpired ? '有效' : '无效';
                    const statusClass = card.status === 'active' && !isExpired ? '' : 'style="color: #ff6b6b;"';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${card.key}</td>
                        <td ${statusClass}>${status}</td>
                        <td>${new Date(card.expiry_time).toLocaleString()}</td>
                        <td>${card.user_id || '未绑定'}</td>
                        <td>
                            <button onclick="editCard('${card.key}')">编辑</button>
                            <button class="btn-danger" onclick="deleteCard('${card.key}')">删除</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('加载卡密失败:', error);
                document.getElementById('cards-tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #ff6b6b;">加载失败</td></tr>';
            }
        }
        
        // 生成卡密
        document.getElementById('generate-cards').addEventListener('click', async function() {
            const count = parseInt(document.getElementById('card-count').value) || 1;
            const days = parseInt(document.getElementById('card-days').value) || 30;
            
            if (count > 100) {
                alert('一次最多生成100个卡密！');
                return;
            }
            
            const cards = [];
            const successElement = document.getElementById('generate-success');
            const textarea = document.getElementById('generated-cards');
            
            try {
                for (let i = 0; i < count; i++) {
                    const cardKey = generateCardKey();
                    const expiryTime = new Date();
                    expiryTime.setDate(expiryTime.getDate() + days);
                    
                    const { error } = await supabase
                        .from('cards')
                        .insert([
                            {
                                key: cardKey,
                                status: 'active',
                                expiry_time: expiryTime.toISOString(),
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (!error) {
                        cards.push(cardKey);
                    }
                }
                
                textarea.value = cards.join('\n');
                successElement.textContent = `成功生成 ${cards.length} 个卡密！`;
                
                // 刷新卡密列表
                loadCards();
                loadStats();
            } catch (error) {
                console.error('生成卡密失败:', error);
                successElement.textContent = '生成卡密失败！';
            }
        });
        
        // 复制卡密
        document.getElementById('copy-cards').addEventListener('click', function() {
            const textarea = document.getElementById('generated-cards');
            textarea.select();
            document.execCommand('copy');
            alert('卡密已复制到剪贴板！');
        });
        
        // 刷新用户列表
        document.getElementById('refresh-users').addEventListener('click', loadUsers);
        
        // 刷新卡密列表
        document.getElementById('refresh-cards').addEventListener('click', loadCards);
        
        // 生成随机卡密
        function generateCardKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
                if ((i + 1) % 4 === 0 && i < 15) {
                    result += '-';
                }
            }
            return result;
        }
        
        // 重置用户功德
        window.resetMerit = async function(userId) {
            if (confirm('确定要重置该用户的功德值吗？')) {
                try {
                    const { error } = await supabase
                        .from('merit')
                        .update({ count: 0 })
                        .eq('user_id', userId);
                    
                    if (!error) {
                        alert('功德值已重置！');
                        loadUsers();
                        loadStats();
                    }
                } catch (error) {
                    console.error('重置功德失败:', error);
                    alert('重置失败！');
                }
            }
        }
        
        // 删除用户
        window.deleteUser = async function(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可恢复！')) {
                try {
                    const { error } = await supabase
                        .from('merit')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (!error) {
                        alert('用户已删除！');
                        loadUsers();
                        loadStats();
                    }
                } catch (error) {
                    console.error('删除用户失败:', error);
                    alert('删除失败！');
                }
            }
        }
        
        // 删除卡密
        window.deleteCard = async function(cardKey) {
            if (confirm('确定要删除这个卡密吗？此操作不可恢复！')) {
                try {
                    const { error } = await supabase
                        .from('cards')
                        .delete()
                        .eq('key', cardKey);
                    
                    if (!error) {
                        alert('卡密已删除！');
                        loadCards();
                        loadStats();
                    }
                } catch (error) {
                    console.error('删除卡密失败:', error);
                    alert('删除失败！');
                }
            }
        }
        
        // 编辑卡密
        window.editCard = async function(cardKey) {
            const newExpiry = prompt('请输入新的过期时间 (YYYY-MM-DD HH:MM:SS):');
            if (newExpiry) {
                const expiryTime = new Date(newExpiry);
                if (isNaN(expiryTime.getTime())) {
                    alert('日期格式不正确！');
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from('cards')
                        .update({ expiry_time: expiryTime.toISOString() })
                        .eq('key', cardKey);
                    
                    if (!error) {
                        alert('卡密已更新！');
                        loadCards();
                    }
                } catch (error) {
                    console.error('更新卡密失败:', error);
                    alert('更新失败！');
                }
            }
        }
        
        // 页面加载时检查登录状态
        window.addEventListener('load', function() {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadDashboard();
            }
            
            // 监听Enter键登录
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('login-btn').click();
                }
            });
        });
    </script>
</body>
</html>
